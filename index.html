<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Demo Consentimiento (Transcend)</title>

    <!-- Transcend Airgap (debe ir primero en el <head>) -->
    <script
      data-cfasync="false"
      src="https://transcend-cdn.com/cm/7fe0784a-dcb5-4fee-8517-4c00684b5d98/airgap.js"
    ></script>

    <style>
      :root{
        --bg:#0b1220;
        --card:#101a2e;
        --text:#e8eefc;
        --muted:#a9b7d7;
        --border:rgba(255,255,255,.12);
        --accent:#6ea8fe;
        --ok:#39d98a;
        --warn:#ffb020;
        --bad:#ff6b6b;
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: radial-gradient(1200px 600px at 30% 10%, rgba(110,168,254,.20), transparent 60%),
                    radial-gradient(900px 600px at 80% 40%, rgba(57,217,138,.15), transparent 60%),
                    var(--bg);
        color:var(--text);
      }
      .wrap{
        max-width: 1100px;
        margin: 40px auto;
        padding: 0 16px;
      }
      .grid{
        display:grid;
        grid-template-columns: 1.1fr .9fr;
        gap: 16px;
      }
      @media (max-width: 900px){
        .grid{grid-template-columns:1fr}
      }
      .card{
        background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px;
        backdrop-filter: blur(10px);
      }
      h1{margin:0 0 8px; font-size: 22px}
      p{margin:0 0 12px; color: var(--muted); line-height: 1.5}
      label{display:block; font-size: 13px; color: var(--muted); margin: 10px 0 6px}
      input[type="text"], input[type="email"], input[type="password"]{
        width: 100%;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,.06);
        color: var(--text);
        padding: 10px 12px;
        outline: none;
      }
      input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus{
        border-color: rgba(110,168,254,.8);
        box-shadow: 0 0 0 3px rgba(110,168,254,.15);
      }
      .checks{
        margin-top: 14px;
        display:grid;
        gap: 10px;
      }
      .check{
        border: 1px solid var(--border);
        background: rgba(255,255,255,.04);
        border-radius: 12px;
        padding: 10px 12px;
      }
      .row{
        display:flex; align-items:flex-start; gap: 10px;
      }
      .row input{margin-top: 3px}
      .title{
        display:flex; gap:10px; align-items:center; flex-wrap:wrap;
        font-weight: 700;
      }
      .pill{
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
      }
      .pill.req{color: #ffd18b; border-color: rgba(255,177,32,.35); background: rgba(255,177,32,.12)}
      .pill.opt{color: #a7d5ff; border-color: rgba(110,168,254,.35); background: rgba(110,168,254,.10)}
      .help{font-size: 12px; color: var(--muted); margin-top: 4px}
      .actions{
        margin-top: 14px;
        display:flex; gap: 10px; flex-wrap: wrap;
      }
      button{
        border: 0;
        border-radius: 12px;
        padding: 10px 14px;
        color: #07121f;
        background: var(--accent);
        font-weight: 700;
        cursor:pointer;
      }
      button.secondary{
        background: rgba(255,255,255,.10);
        color: var(--text);
        border: 1px solid var(--border);
      }
      button.danger{
        background: rgba(255,107,107,.15);
        color: var(--text);
        border: 1px solid rgba(255,107,107,.35);
      }
      .status{
        margin-top: 14px;
        border-radius: 12px;
        padding: 10px 12px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,.04);
        color: var(--muted);
        font-size: 13px;
        white-space: pre-wrap;
      }
      .ok{color: var(--ok)}
      .bad{color: var(--bad)}
      code{
        background: rgba(255,255,255,.08);
        padding: 1px 6px;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      ul{margin: 8px 0 0 18px; color: var(--muted)}
      .note{
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        border-left: 3px solid rgba(110,168,254,.5);
        padding-left: 10px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="grid">
        <div class="card">
          <h1>Registro con Consentimiento (Demo)</h1>
          <p>
            Esta p√°gina simula un flujo t√≠pico: el usuario crea cuenta y entrega consentimientos.
            Guardamos el resultado localmente (en el navegador) y tambi√©n enviamos la se√±al a Transcend (Airgap).
          </p>

          <form id="consentForm">
            <label for="name">Nombre</label>
            <input id="name" type="text" value="Alfredo Ovalle" required />

            <label for="email">Email</label>
            <input id="email" type="email" value="aovalle@miuandes.cl" required />

            <label for="password">Contrase√±a</label>
            <input id="password" type="password" value="demo1234" required />

            <div class="checks">
              <div class="check">
                <div class="row">
                  <input id="terms" type="checkbox" checked />
                  <div>
                    <div class="title">
                      Acepto T√©rminos y Pol√≠tica de Privacidad
                      <span class="pill req">Obligatorio</span>
                    </div>
                    <div class="help">
                      Confirma que le√≠ste y aceptas los t√©rminos y la pol√≠tica de privacidad del sitio.
                    </div>
                  </div>
                </div>
              </div>

              <div class="check">
                <div class="row">
                  <input id="personalData" type="checkbox" checked />
                  <div>
                    <div class="title">
                      Consentimiento de tratamiento de datos personales
                      <span class="pill req">Obligatorio</span>
                    </div>
                    <div class="help">
                      Autorizas el uso de tus datos para crear tu cuenta, operar el servicio y cumplir obligaciones legales.
                    </div>
                  </div>
                </div>
              </div>

              <div class="check">
                <div class="row">
                  <input id="marketing" type="checkbox" />
                  <div>
                    <div class="title">
                      Quiero recibir marketing y promociones
                      <span class="pill opt">Opcional</span>
                    </div>
                    <div class="help">
                      Emails de promociones, novedades y descuentos. Puedes desuscribirte en cualquier momento.
                    </div>
                  </div>
                </div>
              </div>

              <div class="check">
                <div class="row">
                  <input id="analytics" type="checkbox" checked />
                  <div>
                    <div class="title">
                      Permitir anal√≠ticas (cookies/medici√≥n)
                      <span class="pill opt">Opcional</span>
                    </div>
                    <div class="help">
                      Nos ayuda a entender el uso del sitio y mejorar su desempe√±o.
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="actions">
              <button type="submit">Crear cuenta</button>
              <button type="button" class="secondary" id="viewBtn">Ver consentimiento guardado</button>
              <button type="button" class="danger" id="clearBtn">Borrar consentimiento</button>
            </div>

            <div class="status" id="statusBox">Listo. Completa el formulario y presiona ‚ÄúCrear cuenta‚Äù.</div>

            <div class="note">
              Tip: abre DevTools ‚Üí Application ‚Üí Local Storage y busca la clave <code>demo_consent</code>.
            </div>
          </form>
        </div>

        <div class="card">
          <h1>Qu√© se guarda (demo)</h1>
          <p>Al enviar el formulario guardamos:</p>
          <ul>
            <li>Email (solo para demo)</li>
            <li>Consentimiento t√©rminos (true/false)</li>
            <li>Consentimiento datos personales (true/false)</li>
            <li>Marketing (true/false)</li>
            <li>Analytics (true/false)</li>
            <li>Timestamp (fecha/hora)</li>
          </ul>
          <p class="note">
            Adem√°s, despu√©s de guardar, enviamos el consentimiento a Transcend con
            <code>window.transcend.consent.setConsent(...)</code>.
          </p>
          <p class="note">
            Si no ves efectos, revisa que tu dominio est√© permitido en Transcend (Allowed domains),
            y que la experiencia regional aplique a tu ubicaci√≥n.
          </p>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("consentForm");
      const statusBox = document.getElementById("statusBox");
      const viewBtn = document.getElementById("viewBtn");
      const clearBtn = document.getElementById("clearBtn");

      function setStatus(msg, type) {
        statusBox.textContent = msg;
        statusBox.classList.remove("ok", "bad");
        if (type) statusBox.classList.add(type);
      }

      function readFormValues() {
        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const terms = document.getElementById("terms").checked;
        const personalData = document.getElementById("personalData").checked;
        const marketing = document.getElementById("marketing").checked;
        const analytics = document.getElementById("analytics").checked;

        return { name, email, terms, personalData, marketing, analytics };
      }

      function saveConsent(payload) {
        localStorage.setItem("demo_consent", JSON.stringify(payload));
      }

      function loadConsent() {
        const raw = localStorage.getItem("demo_consent");
        return raw ? JSON.parse(raw) : null;
      }

      function clearConsent() {
        localStorage.removeItem("demo_consent");
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const { name, email, terms, personalData, marketing, analytics } = readFormValues();

        // Validaciones m√≠nimas para demo
        if (!terms) {
          setStatus("‚ùå Debes aceptar T√©rminos y Pol√≠tica de Privacidad.", "bad");
          return;
        }
        if (!personalData) {
          setStatus("‚ùå Debes aceptar el tratamiento de datos personales (obligatorio).", "bad");
          return;
        }

        const payload = {
          name,
          email,
          terms,
          personalData,
          marketing,
          analytics,
          timestamp: new Date().toISOString(),
        };

        // 1) Guardar localmente (demo)
        saveConsent(payload);

        // 2) ‚úÖ Despu√©s de guardar: enviar se√±al a Transcend (Airgap)
        // Ajusta los keys si tus "purpose slugs" son distintos en Transcend
        try {
          if (window.transcend && window.transcend.consent && typeof window.transcend.consent.setConsent === "function") {
            window.transcend.consent.setConsent({
              // Slugs t√≠picos:
              Advertising: marketing,   // marketing/promos
              Analytics: analytics,     // anal√≠ticas
              Functional: true,         // normalmente "siempre on" si tu sitio lo requiere
              SaleOfInfo: false,        // demo
              Essential: true           // normalmente "No Consent Needed"
            });
          }
        } catch (err) {
          // no bloqueamos el flujo demo si falla
          console.warn("Transcend setConsent error:", err);
        }

        setStatus(
          "‚úÖ Consentimiento guardado.\n" +
          "Email: " + email + "\n" +
          "Fecha: " + payload.timestamp + "\n\n" +
          "Se intent√≥ enviar setConsent() a Transcend (revisa consola/Transcend dashboard).",
          "ok"
        );
      });

      viewBtn.addEventListener("click", () => {
        const data = loadConsent();
        if (!data) {
          setStatus("No hay consentimiento guardado a√∫n.", "");
          return;
        }
        setStatus("üì¶ demo_consent:\n" + JSON.stringify(data, null, 2), "ok");
      });

      clearBtn.addEventListener("click", () => {
        clearConsent();

        // Opcional: tambi√©n ‚Äúresetear‚Äù en Transcend (depende de tu config)
        try {
          if (window.transcend && window.transcend.consent && typeof window.transcend.consent.setConsent === "function") {
            window.transcend.consent.setConsent({
              Advertising: false,
              Analytics: false,
              Functional: true,
              SaleOfInfo: false,
              Essential: true
            });
          }
        } catch (err) {
          console.warn("Transcend reset error:", err);
        }

        setStatus("üóëÔ∏è Consentimiento borrado (localStorage) y se intent√≥ resetear en Transcend.", "");
      });
    </script>
  </body>
</html>
